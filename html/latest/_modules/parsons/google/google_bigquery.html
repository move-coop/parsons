

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>parsons.google.google_bigquery &mdash; Parsons  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=7ab3649f" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Parsons
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Integrations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../actblue.html">ActBlue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../action_kit.html">ActionKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../action_builder.html">Action Builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../action_network.html">Action Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../airmeet.html">Airmeet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../airtable.html">Airtable</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../alchemer.html">Alchemer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auth0.html">Auth0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aws.html">Amazon Web Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../azure.html">Azure: Blob Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bill_com.html">Bill.com</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bloomerang.html">Bloomerang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../box.html">Box</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../braintree.html">Braintree</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../capitolcanary.html">CapitolCanary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../census.html">Census</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../civis.html">Civis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../controlshift.html">Controlshift</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copper.html">Copper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../crowdtangle.html">CrowdTangle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../databases.html">Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../donorbox.html">Donorbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../empower.html">Empower</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../facebook_ads.html">FacebookAds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../formstack.html">Formstack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../freshdesk.html">Freshdesk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../github.html">GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../google.html">Google</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hustle.html">Hustle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mailchimp.html">Mailchimp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobilecommons.html">MobileCommons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobilize_america.html">Mobilize America</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nation_builder.html">NationBuilder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../newmode.html">New/Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ngpvan.html">NGPVAN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../p2a.html">Phone2Action</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pdi.html">PDI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickbase.html">Quickbase</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../redash.html">Redash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rockthevote.html">Rock the Vote</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../salesforce.html">Salesforce</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scytl.html">Scytl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sftp.html">SFTP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../shopify.html">Shopify</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sisense.html">Sisense</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../targetsmart.html">TargetSmart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../turbovote.html">TurboVote</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../twilio.html">Twilio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../zoom.html">Zoom</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Enhancements</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../census_geocoder.html">US Census Geocoder</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Framework</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../dbsync.html">Database Sync</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../table.html">Parsons Table</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notifications.html">Notifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utilities.html">Utilities</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributor Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing to Parsons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build_a_connector.html">How to Build a Connector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../write_tests.html">How to Write Tests for Parsons Connectors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use Cases and Sample Scripts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../use_cases/contribute_use_cases.html">How to Contribute a Use Case &amp; Sample Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../use_cases/civis_job_status_slack_alert.html">Civis Job Status Slack Alert</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../use_cases/mysql_to_googlesheets.html">MySQL to Google Sheets Export</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Training Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../training_guides/getting_set_up.html">Getting Set Up With Parsons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../training_guides/etl_best_practices.html">Introduction to ETL Best Practices</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Parsons</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">parsons.google.google_bigquery</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for parsons.google.google_bigquery</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">google</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">petl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.cloud</span><span class="w"> </span><span class="kn">import</span> <span class="n">bigquery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.api_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.cloud.bigquery</span><span class="w"> </span><span class="kn">import</span> <span class="n">dbapi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.cloud.bigquery.job</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoadJobConfig</span><span class="p">,</span> <span class="n">ExtractJobConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.cloud.bigquery</span><span class="w"> </span><span class="kn">import</span> <span class="n">job</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.oauth2.credentials</span><span class="w"> </span><span class="kn">import</span> <span class="n">Credentials</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">parsons.databases.database_connector</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatabaseConnector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parsons.databases.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseTable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parsons.etl</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parsons.google.google_cloud_storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">GoogleCloudStorage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parsons.google.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">load_google_application_credentials</span><span class="p">,</span>
    <span class="n">setup_google_application_credentials</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parsons.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_env</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parsons.utilities.files</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_temp_file</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">BIGQUERY_TYPE_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;str&quot;</span><span class="p">:</span> <span class="s2">&quot;STRING&quot;</span><span class="p">,</span>
    <span class="s2">&quot;float&quot;</span><span class="p">:</span> <span class="s2">&quot;FLOAT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bool&quot;</span><span class="p">:</span> <span class="s2">&quot;BOOLEAN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;DATE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;TIME&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NoneType&quot;</span><span class="p">:</span> <span class="s2">&quot;STRING&quot;</span><span class="p">,</span>
    <span class="s2">&quot;UUID&quot;</span><span class="p">:</span> <span class="s2">&quot;STRING&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;TIMESTAMP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Decimal&quot;</span><span class="p">:</span> <span class="s2">&quot;FLOAT&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Max number of rows that we query at a time, so we can avoid loading huge</span>
<span class="c1"># data sets into memory.</span>
<span class="c1"># 100k rows per batch at ~1k bytes each = ~100MB per batch.</span>
<span class="n">QUERY_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">100000</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
    <span class="c1"># Helper function to parse out the different components of a table ID</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">table_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">parsed</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">parsed</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">parsed</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">parsed</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ends_with_semicolon</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">query</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query</span>
    <span class="k">return</span> <span class="n">query</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">map_column_headers_to_schema_field</span><span class="p">(</span><span class="n">schema_definition</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loops through a list of dictionaries and instantiates</span>
<span class="sd">    google.cloud.bigquery.SchemaField objects. Useful docs</span>
<span class="sd">    from Google&#39;s API can be found here:</span>
<span class="sd">        https://cloud.google.com/python/docs/reference/bigquery/latest/google.cloud.bigquery.schema.SchemaField</span>

<span class="sd">    `Args`:</span>
<span class="sd">        schema_definition: list</span>
<span class="sd">        This function expects a list of dictionaries in the following format:</span>

<span class="sd">        ```</span>
<span class="sd">        schema_definition = [</span>
<span class="sd">            {</span>
<span class="sd">                &quot;name&quot;: column_name,</span>
<span class="sd">                &quot;field_type&quot;: [INTEGER, STRING, FLOAT, etc.]</span>
<span class="sd">            },</span>
<span class="sd">            {</span>
<span class="sd">                &quot;name&quot;: column_name,</span>
<span class="sd">                &quot;field_type&quot;: [INTEGER, STRING, FLOAT, etc.],</span>
<span class="sd">                &quot;mode&quot;: &quot;REQUIRED&quot;</span>
<span class="sd">            },</span>
<span class="sd">            {</span>
<span class="sd">                &quot;name&quot;: column_name,</span>
<span class="sd">                &quot;field_type&quot;: [INTEGER, STRING, FLOAT, etc.],</span>
<span class="sd">                &quot;default_value_expression&quot;: CURRENT_TIMESTAMP()</span>
<span class="sd">            }</span>
<span class="sd">        ]</span>
<span class="sd">        ```</span>

<span class="sd">    `Returns`:</span>
<span class="sd">        List of instantiated `SchemaField` objects</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO - Better way to test for this</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema_definition</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;User supplied list of SchemaField objects&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">schema_definition</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">schema_definition</span><span class="p">]</span>


<div class="viewcode-block" id="GoogleBigQuery">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GoogleBigQuery</span><span class="p">(</span><span class="n">DatabaseConnector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for querying BigQuery table and returning the data as Parsons tables.</span>

<span class="sd">    This class requires application credentials in the form of a json. It can be passed</span>
<span class="sd">    in the following ways:</span>

<span class="sd">    * Set an environmental variable named ``GOOGLE_APPLICATION_CREDENTIALS`` with the</span>
<span class="sd">      local path to the credentials json.</span>

<span class="sd">      Example: ``GOOGLE_APPLICATION_CREDENTALS=&#39;path/to/creds.json&#39;``</span>

<span class="sd">    * Pass in the path to the credentials using the ``app_creds`` argument.</span>

<span class="sd">    * Pass in a json string using the ``app_creds`` argument.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_creds: str</span>
<span class="sd">            A credentials json string or a path to a json file. Not required</span>
<span class="sd">            if ``GOOGLE_APPLICATION_CREDENTIALS`` env variable set.</span>
<span class="sd">        project: str</span>
<span class="sd">            The project which the client is acting on behalf of. If not passed</span>
<span class="sd">            then will use the default inferred environment.</span>
<span class="sd">        location: str</span>
<span class="sd">            Default geographic location for tables</span>
<span class="sd">        client_options: dict</span>
<span class="sd">            A dictionary containing any requested client options. Defaults to the required</span>
<span class="sd">            scopes for making API calls against External tables stored in Google Drive.</span>
<span class="sd">            Can be set to None if these permissions are not desired</span>
<span class="sd">        gcs_temp_bucket: str</span>
<span class="sd">            Name of the GCS bucket that will be used for storing data during bulk transfers.</span>
<span class="sd">            Required if you intend to perform bulk data transfers (eg. the copy_from_gcs method),</span>
<span class="sd">            and env variable ``GCS_TEMP_BUCKET`` is not populated.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">app_creds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">Credentials</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">client_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;scopes&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;https://www.googleapis.com/auth/drive&quot;</span><span class="p">,</span>
                <span class="s2">&quot;https://www.googleapis.com/auth/bigquery&quot;</span><span class="p">,</span>
                <span class="s2">&quot;https://www.googleapis.com/auth/cloud-platform&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="n">tmp_gcs_bucket</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_creds</span> <span class="o">=</span> <span class="n">app_creds</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">app_creds</span><span class="p">,</span> <span class="n">Credentials</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span> <span class="o">=</span> <span class="n">app_creds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env_credential_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="n">setup_google_application_credentials</span><span class="p">(</span>
                <span class="n">app_creds</span><span class="p">,</span> <span class="n">target_env_var_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env_credential_path</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">credentials</span> <span class="o">=</span> <span class="n">load_google_application_credentials</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env_credential_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_options</span> <span class="o">=</span> <span class="n">client_options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_gcs_bucket</span> <span class="o">=</span> <span class="n">tmp_gcs_bucket</span>

        <span class="c1"># We will not create the client until we need to use it, since creating the client</span>
        <span class="c1"># without valid GOOGLE_APPLICATION_CREDENTIALS raises an exception.</span>
        <span class="c1"># This attribute will be used to hold the client once we have created it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi</span> <span class="o">=</span> <span class="n">dbapi</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span> <span class="o">=</span> <span class="s2">&quot;bigquery&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Google BigQuery client to use for making queries.</span>

<span class="sd">        `Returns:`</span>
<span class="sd">            `google.cloud.bigquery.client.Client`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="c1"># Create a BigQuery client to use to make the query</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
                <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                <span class="n">client_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client_options</span><span class="p">,</span>
                <span class="n">credentials</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">credentials</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span>

<div class="viewcode-block" id="GoogleBigQuery.connection">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.connection">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a BigQuery connection.</span>
<span class="sd">        The connection is set up as a python &quot;context manager&quot;, so it will be closed</span>
<span class="sd">        automatically when the connection goes out of scope. Note that the BigQuery</span>
<span class="sd">        API uses jobs to run database operations and, as such, simply has a no-op for</span>
<span class="sd">        a &quot;commit&quot; function.</span>

<span class="sd">        If you would like to manage transactions, please use multi-statement queries</span>
<span class="sd">        as [outlined here](https://cloud.google.com/bigquery/docs/transactions)</span>
<span class="sd">        or utilize the `query_with_transaction` method on this class.</span>

<span class="sd">        When using the connection, make sure to put it in a ``with`` block (necessary for</span>
<span class="sd">        any context manager):</span>
<span class="sd">        ``with bq.connection() as conn:``</span>

<span class="sd">        `Returns:`</span>
<span class="sd">            Google BigQuery ``connection`` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">conn</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">cur</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="GoogleBigQuery.query">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.query">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">return_values</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Table</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a BigQuery query and return the results as a Parsons table.</span>

<span class="sd">        To include python variables in your query, it is recommended to pass them as parameters,</span>
<span class="sd">        following the BigQuery style where parameters are prefixed with `@`s.</span>
<span class="sd">        Using the ``parameters`` argument ensures that values are escaped properly, and avoids SQL</span>
<span class="sd">        injection attacks.</span>

<span class="sd">        **Parameter Examples**</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">           name = &quot;Beatrice O&#39;Brady&quot;</span>
<span class="sd">           sql = &#39;SELECT * FROM my_table WHERE name = %s&#39;</span>
<span class="sd">           rs.query(sql, parameters=[name])</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">           name = &quot;Beatrice O&#39;Brady&quot;</span>
<span class="sd">           sql = &quot;SELECT * FROM my_table WHERE name = %(name)s&quot;</span>
<span class="sd">           rs.query(sql, parameters={&#39;name&#39;: name})</span>

<span class="sd">        `Args:`</span>
<span class="sd">            sql: str</span>
<span class="sd">                A valid BigTable statement</span>
<span class="sd">            parameters: dict</span>
<span class="sd">                A dictionary of query parameters for BigQuery.</span>

<span class="sd">        `Returns:`</span>
<span class="sd">            Parsons Table</span>
<span class="sd">                See :ref:`parsons-table` for output options.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_with_connection</span><span class="p">(</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">return_values</span><span class="o">=</span><span class="n">return_values</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="GoogleBigQuery.query_with_connection">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.query_with_connection">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_with_connection</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_values</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a query against the BigQuery database, with an existing connection.</span>
<span class="sd">        Useful for batching queries together. Will return ``None`` if the query</span>
<span class="sd">        returns zero rows.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            sql: str</span>
<span class="sd">                A valid SQL statement</span>
<span class="sd">            connection: obj</span>
<span class="sd">                A connection object obtained from ``redshift.connection()``</span>
<span class="sd">            parameters: list</span>
<span class="sd">                A list of python variables to be converted into SQL values in your query</span>
<span class="sd">            commit: boolean</span>
<span class="sd">                Must be true. BigQuery</span>

<span class="sd">        `Returns:`</span>
<span class="sd">            Parsons Table</span>
<span class="sd">                See :ref:`parsons-table` for output options.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">commit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                BigQuery implementation uses an API client which always auto-commits.</span>
<span class="sd">                If you wish to wrap multiple queries in a transaction, use</span>
<span class="sd">                Mulit-Statement transactions within a single query as outlined</span>
<span class="sd">                here: https://cloud.google.com/bigquery/docs/transactions or use the</span>
<span class="sd">                `query_with_transaction` method on the BigQuery connector.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># get our connection and cursor</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="c1"># Run the query</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">return_values</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># This applies when running a SQL statement without any return value</span>
            <span class="c1"># e.g. when creating a view or a table</span>
            <span class="c1"># This does not apply when 0 rows are returned</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">final_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_query_results</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">final_table</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">query_with_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">queries_with_semicolons</span> <span class="o">=</span> <span class="p">[</span><span class="n">ends_with_semicolon</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">]</span>
        <span class="n">queries_on_newlines</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">queries_with_semicolons</span><span class="p">)</span>
        <span class="n">queries_wrapped</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        BEGIN</span>
<span class="s2">            BEGIN TRANSACTION;</span>
<span class="s2">            </span><span class="si">{</span><span class="n">queries_on_newlines</span><span class="si">}</span>
<span class="s2">            COMMIT TRANSACTION;</span>
<span class="s2">        END;</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">queries_wrapped</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">return_values</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="GoogleBigQuery.get_job">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.get_job">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_job</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">job_kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">LoadJob</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">CopyJob</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">ExtractJob</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">QueryJob</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">UnknownJob</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch a job</span>

<span class="sd">        `Args:`</span>
<span class="sd">            job_id: str</span>
<span class="sd">                ID of job to fetch</span>
<span class="sd">            location: str</span>
<span class="sd">                Location where the job was run</span>
<span class="sd">            **job_kwargs: kwargs</span>
<span class="sd">                Other arguments to pass to the underlying get_job</span>
<span class="sd">                call on the BigQuery client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="o">**</span><span class="n">job_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="GoogleBigQuery.copy_from_gcs">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.copy_from_gcs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy_from_gcs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">gcs_blob_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">if_exists</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fail&quot;</span><span class="p">,</span>
        <span class="n">max_errors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="n">csv_delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span>
        <span class="n">ignoreheader</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">nullas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_quoted_newlines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_jagged_rows</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">quote</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LoadJobConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">force_unzip_blobs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">compression_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
        <span class="n">new_file_extension</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="n">template_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21600</span><span class="p">,</span>
        <span class="o">**</span><span class="n">load_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy a csv saved in Google Cloud Storage into Google BigQuery.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            gcs_blob_uri: str</span>
<span class="sd">                The GoogleCloudStorage URI referencing the file to be copied.</span>
<span class="sd">            table_name: str</span>
<span class="sd">                The table name to load the data into. Will be used to generate load schema</span>
<span class="sd">                if no custom schema or template table are supplied and the if_exists is</span>
<span class="sd">                set to &quot;truncate&quot; or &quot;append&quot;.</span>
<span class="sd">            if_exists: str</span>
<span class="sd">                If the table already exists, either ``fail``, ``append``, ``drop``</span>
<span class="sd">                or ``truncate`` the table. This maps to `write_disposition` in the</span>
<span class="sd">                `LoadJobConfig` class.</span>
<span class="sd">            max_errors: int</span>
<span class="sd">                The maximum number of rows that can error and be skipped before</span>
<span class="sd">                the job fails. This maps to `max_bad_records` in the `LoadJobConfig` class.</span>
<span class="sd">            data_type: str</span>
<span class="sd">                Denotes whether target file is a JSON or CSV</span>
<span class="sd">            csv_delimiter: str</span>
<span class="sd">                Character used to separate values in the target file</span>
<span class="sd">            ignoreheader: int</span>
<span class="sd">                Treats the specified number_rows as a file header and doesn&#39;t load them</span>
<span class="sd">            nullas: str</span>
<span class="sd">                Loads fields that match null_string as NULL, where null_string can be any string</span>
<span class="sd">            allow_quoted_newlines: bool</span>
<span class="sd">                If True, detects quoted new line characters within a CSV field and does</span>
<span class="sd">                not interpret the quoted new line character as a row boundary</span>
<span class="sd">            allow_jagged_rows: bool</span>
<span class="sd">                Allow missing trailing optional columns (CSV only).</span>
<span class="sd">            quote: str</span>
<span class="sd">                The value that is used to quote data sections in a CSV file.</span>
<span class="sd">                BigQuery converts the string to ISO-8859-1 encoding, and then uses the first byte of</span>
<span class="sd">                the encoded string to split the data in its raw, binary state.</span>
<span class="sd">            schema: list</span>
<span class="sd">                BigQuery expects a list of dictionaries in the following format</span>
<span class="sd">                ```</span>
<span class="sd">                schema = [</span>
<span class="sd">                    {&quot;name&quot;: &quot;column_name&quot;, &quot;type&quot;: STRING},</span>
<span class="sd">                    {&quot;name&quot;: &quot;another_column_name&quot;, &quot;type&quot;: INT}</span>
<span class="sd">                ]</span>
<span class="sd">                ```</span>
<span class="sd">            job_config: object</span>
<span class="sd">                A LoadJobConfig object to provide to the underlying call to load_table_from_uri</span>
<span class="sd">                on the BigQuery client. The function will create its own if not provided. Note</span>
<span class="sd">                if there are any conflicts between the job_config and other parameters, the</span>
<span class="sd">                job_config values are preferred.</span>
<span class="sd">            force_unzip_blobs: bool</span>
<span class="sd">                If True, target blobs will be unzipped before being loaded to BigQuery.</span>
<span class="sd">            compression_type: str</span>
<span class="sd">                Accepts `zip` or `gzip` values to differentially unzip a compressed</span>
<span class="sd">                blob in cloud storage.</span>
<span class="sd">            new_file_extension: str</span>
<span class="sd">                Provides a file extension if a blob is decompressed and rewritten</span>
<span class="sd">                to cloud storage.</span>
<span class="sd">            template_table: str</span>
<span class="sd">                Table name to be used as the load schema. Load operation wil use the same</span>
<span class="sd">                columns and data types as the template table.</span>
<span class="sd">            max_timeout: int</span>
<span class="sd">                The maximum number of seconds to wait for a request before the job fails.</span>
<span class="sd">            **load_kwargs: kwargs</span>
<span class="sd">                Other arguments to pass to the underlying load_table_from_uri</span>
<span class="sd">                call on the BigQuery client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_copy_inputs</span><span class="p">(</span><span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">)</span>

        <span class="n">job_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_job_config</span><span class="p">(</span>
            <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
            <span class="n">destination_table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
            <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">,</span>
            <span class="n">max_errors</span><span class="o">=</span><span class="n">max_errors</span><span class="p">,</span>
            <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
            <span class="n">csv_delimiter</span><span class="o">=</span><span class="n">csv_delimiter</span><span class="p">,</span>
            <span class="n">ignoreheader</span><span class="o">=</span><span class="n">ignoreheader</span><span class="p">,</span>
            <span class="n">nullas</span><span class="o">=</span><span class="n">nullas</span><span class="p">,</span>
            <span class="n">allow_quoted_newlines</span><span class="o">=</span><span class="n">allow_quoted_newlines</span><span class="p">,</span>
            <span class="n">allow_jagged_rows</span><span class="o">=</span><span class="n">allow_jagged_rows</span><span class="p">,</span>
            <span class="n">quote</span><span class="o">=</span><span class="n">quote</span><span class="p">,</span>
            <span class="n">custom_schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">template_table</span><span class="o">=</span><span class="n">template_table</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># load CSV from Cloud Storage into BigQuery</span>
        <span class="n">table_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_ref</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force_unzip_blobs</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_large_compressed_file_from_gcs</span><span class="p">(</span>
                    <span class="n">gcs_blob_uri</span><span class="o">=</span><span class="n">gcs_blob_uri</span><span class="p">,</span>
                    <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                    <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">,</span>
                    <span class="n">max_errors</span><span class="o">=</span><span class="n">max_errors</span><span class="p">,</span>
                    <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
                    <span class="n">csv_delimiter</span><span class="o">=</span><span class="n">csv_delimiter</span><span class="p">,</span>
                    <span class="n">ignoreheader</span><span class="o">=</span><span class="n">ignoreheader</span><span class="p">,</span>
                    <span class="n">nullas</span><span class="o">=</span><span class="n">nullas</span><span class="p">,</span>
                    <span class="n">allow_quoted_newlines</span><span class="o">=</span><span class="n">allow_quoted_newlines</span><span class="p">,</span>
                    <span class="n">quote</span><span class="o">=</span><span class="n">quote</span><span class="p">,</span>
                    <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                    <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
                    <span class="n">compression_type</span><span class="o">=</span><span class="n">compression_type</span><span class="p">,</span>
                    <span class="n">new_file_extension</span><span class="o">=</span><span class="n">new_file_extension</span><span class="p">,</span>
                    <span class="n">max_timeout</span><span class="o">=</span><span class="n">max_timeout</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_table_from_uri</span><span class="p">(</span>
                    <span class="n">source_uris</span><span class="o">=</span><span class="n">gcs_blob_uri</span><span class="p">,</span>
                    <span class="n">destination</span><span class="o">=</span><span class="n">table_ref</span><span class="p">,</span>
                    <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
                    <span class="n">max_timeout</span><span class="o">=</span><span class="n">max_timeout</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">load_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;one of the files is larger than the maximum allowed size.&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gcs_blob_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> exceeds max size ... </span><span class="se">\</span>
<span class="s2">                    running decompression function...&quot;</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_large_compressed_file_from_gcs</span><span class="p">(</span>
                    <span class="n">gcs_blob_uri</span><span class="o">=</span><span class="n">gcs_blob_uri</span><span class="p">,</span>
                    <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                    <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">,</span>
                    <span class="n">max_errors</span><span class="o">=</span><span class="n">max_errors</span><span class="p">,</span>
                    <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
                    <span class="n">csv_delimiter</span><span class="o">=</span><span class="n">csv_delimiter</span><span class="p">,</span>
                    <span class="n">ignoreheader</span><span class="o">=</span><span class="n">ignoreheader</span><span class="p">,</span>
                    <span class="n">nullas</span><span class="o">=</span><span class="n">nullas</span><span class="p">,</span>
                    <span class="n">allow_quoted_newlines</span><span class="o">=</span><span class="n">allow_quoted_newlines</span><span class="p">,</span>
                    <span class="n">quote</span><span class="o">=</span><span class="n">quote</span><span class="p">,</span>
                    <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                    <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
                    <span class="n">compression_type</span><span class="o">=</span><span class="n">compression_type</span><span class="p">,</span>
                    <span class="n">new_file_extension</span><span class="o">=</span><span class="n">new_file_extension</span><span class="p">,</span>
                    <span class="n">max_timeout</span><span class="o">=</span><span class="n">max_timeout</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;Schema has no field&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gcs_blob_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> is empty, skipping file&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;Empty file&quot;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DeadlineExceeded</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max timeout exceeded for </span><span class="si">{</span><span class="n">gcs_blob_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="GoogleBigQuery.copy_large_compressed_file_from_gcs">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.copy_large_compressed_file_from_gcs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy_large_compressed_file_from_gcs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">gcs_blob_uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">if_exists</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fail&quot;</span><span class="p">,</span>
        <span class="n">max_errors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="n">csv_delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span>
        <span class="n">ignoreheader</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">nullas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_quoted_newlines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_jagged_rows</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">quote</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LoadJobConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">compression_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
        <span class="n">new_file_extension</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="n">template_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21600</span><span class="p">,</span>
        <span class="o">**</span><span class="n">load_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy a compressed CSV file that exceeds the maximum size in Google Cloud Storage</span>
<span class="sd">        into Google BigQuery.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            gcs_blob_uri: str</span>
<span class="sd">                The GoogleCloudStorage URI referencing the file to be copied.</span>
<span class="sd">            table_name: str</span>
<span class="sd">                The table name to load the data into. Will be used to generate load schema</span>
<span class="sd">                if no custom schema or template table are supplied and the if_exists is</span>
<span class="sd">                set to &quot;truncate&quot; or &quot;append&quot;.</span>
<span class="sd">            if_exists: str</span>
<span class="sd">                If the table already exists, either ``fail``, ``append``, ``drop``</span>
<span class="sd">                or ``truncate`` the table. This maps to `write_disposition` in the</span>
<span class="sd">                `LoadJobConfig` class.</span>
<span class="sd">            max_errors: int</span>
<span class="sd">                The maximum number of rows that can error and be skipped before</span>
<span class="sd">                the job fails. This maps to `max_bad_records` in the `LoadJobConfig` class.</span>
<span class="sd">            data_type: str</span>
<span class="sd">                Denotes whether target file is a JSON or CSV</span>
<span class="sd">            csv_delimiter: str</span>
<span class="sd">                Character used to separate values in the target file</span>
<span class="sd">            ignoreheader: int</span>
<span class="sd">                Treats the specified number_rows as a file header and doesn&#39;t load them</span>
<span class="sd">            nullas: str</span>
<span class="sd">                Loads fields that match null_string as NULL, where null_string can be any string</span>
<span class="sd">            allow_quoted_newlines: bool</span>
<span class="sd">                If True, detects quoted new line characters within a CSV field</span>
<span class="sd">                and does not interpret the quoted new line character as a row boundary</span>
<span class="sd">            allow_jagged_rows: bool</span>
<span class="sd">                Allow missing trailing optional columns (CSV only).</span>
<span class="sd">            quote: str</span>
<span class="sd">                The value that is used to quote data sections in a CSV file.</span>
<span class="sd">                BigQuery converts the string to ISO-8859-1 encoding, and then uses the first byte of</span>
<span class="sd">                the encoded string to split the data in its raw, binary state.</span>
<span class="sd">            schema: list</span>
<span class="sd">                BigQuery expects a list of dictionaries in the following format</span>
<span class="sd">                ```</span>
<span class="sd">                schema = [</span>
<span class="sd">                    {&quot;name&quot;: &quot;column_name&quot;, &quot;type&quot;: STRING},</span>
<span class="sd">                    {&quot;name&quot;: &quot;another_column_name&quot;, &quot;type&quot;: INT}</span>
<span class="sd">                ]</span>
<span class="sd">                ```</span>
<span class="sd">            job_config: object</span>
<span class="sd">                A LoadJobConfig object to provide to the underlying call to load_table_from_uri</span>
<span class="sd">                on the BigQuery client. The function will create its own if not provided. Note</span>
<span class="sd">                if there are any conflicts between the job_config and other parameters, the</span>
<span class="sd">                job_config values are preferred.</span>
<span class="sd">            compression_type: str</span>
<span class="sd">                Accepts `zip` or `gzip` values to differentially unzip a compressed</span>
<span class="sd">                blob in cloud storage.</span>
<span class="sd">            new_file_extension: str</span>
<span class="sd">                Provides a file extension if a blob is decompressed and rewritten to cloud storage.</span>
<span class="sd">            template_table: str</span>
<span class="sd">                Table name to be used as the load schema. Load operation wil use the same</span>
<span class="sd">                columns and data types as the template table.</span>
<span class="sd">            max_timeout: int</span>
<span class="sd">                The maximum number of seconds to wait for a request before the job fails.</span>
<span class="sd">            **load_kwargs: kwargs</span>
<span class="sd">                Other arguments to pass to the underlying load_table_from_uri call on the BigQuery</span>
<span class="sd">                client.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_copy_inputs</span><span class="p">(</span><span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">)</span>

        <span class="n">job_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_job_config</span><span class="p">(</span>
            <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
            <span class="n">destination_table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
            <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">,</span>
            <span class="n">max_errors</span><span class="o">=</span><span class="n">max_errors</span><span class="p">,</span>
            <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
            <span class="n">csv_delimiter</span><span class="o">=</span><span class="n">csv_delimiter</span><span class="p">,</span>
            <span class="n">ignoreheader</span><span class="o">=</span><span class="n">ignoreheader</span><span class="p">,</span>
            <span class="n">nullas</span><span class="o">=</span><span class="n">nullas</span><span class="p">,</span>
            <span class="n">allow_quoted_newlines</span><span class="o">=</span><span class="n">allow_quoted_newlines</span><span class="p">,</span>
            <span class="n">allow_jagged_rows</span><span class="o">=</span><span class="n">allow_jagged_rows</span><span class="p">,</span>
            <span class="n">quote</span><span class="o">=</span><span class="n">quote</span><span class="p">,</span>
            <span class="n">custom_schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">template_table</span><span class="o">=</span><span class="n">template_table</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># TODO - See if this inheritance is happening in other places</span>
        <span class="n">gcs</span> <span class="o">=</span> <span class="n">GoogleCloudStorage</span><span class="p">(</span><span class="n">app_creds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app_creds</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
        <span class="n">old_bucket_name</span><span class="p">,</span> <span class="n">old_blob_name</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">split_uri</span><span class="p">(</span><span class="n">gcs_uri</span><span class="o">=</span><span class="n">gcs_blob_uri</span><span class="p">)</span>

        <span class="n">uncompressed_gcs_uri</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unzipping large file&quot;</span><span class="p">)</span>
            <span class="n">uncompressed_gcs_uri</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">unzip_blob</span><span class="p">(</span>
                <span class="n">bucket_name</span><span class="o">=</span><span class="n">old_bucket_name</span><span class="p">,</span>
                <span class="n">blob_name</span><span class="o">=</span><span class="n">old_blob_name</span><span class="p">,</span>
                <span class="n">new_file_extension</span><span class="o">=</span><span class="n">new_file_extension</span><span class="p">,</span>
                <span class="n">compression_type</span><span class="o">=</span><span class="n">compression_type</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading uncompressed uri into BigQuery </span><span class="si">{</span><span class="n">uncompressed_gcs_uri</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">table_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_ref</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_table_from_uri</span><span class="p">(</span>
                <span class="n">source_uris</span><span class="o">=</span><span class="n">uncompressed_gcs_uri</span><span class="p">,</span>
                <span class="n">destination</span><span class="o">=</span><span class="n">table_ref</span><span class="p">,</span>
                <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
                <span class="n">max_timeout</span><span class="o">=</span><span class="n">max_timeout</span><span class="p">,</span>
                <span class="o">**</span><span class="n">load_kwargs</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">uncompressed_gcs_uri</span><span class="p">:</span>
                <span class="n">new_bucket_name</span><span class="p">,</span> <span class="n">new_blob_name</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">split_uri</span><span class="p">(</span><span class="n">gcs_uri</span><span class="o">=</span><span class="n">uncompressed_gcs_uri</span><span class="p">)</span>
                <span class="n">gcs</span><span class="o">.</span><span class="n">delete_blob</span><span class="p">(</span><span class="n">new_bucket_name</span><span class="p">,</span> <span class="n">new_blob_name</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully dropped uncompressed blob&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GoogleBigQuery.copy_s3">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.copy_s3">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy_s3</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">,</span>
        <span class="n">bucket</span><span class="p">,</span>
        <span class="n">key</span><span class="p">,</span>
        <span class="n">if_exists</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fail&quot;</span><span class="p">,</span>
        <span class="n">max_errors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="n">csv_delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span>
        <span class="n">ignoreheader</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">nullas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aws_access_key_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aws_secret_access_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gcs_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GoogleCloudStorage</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tmp_gcs_bucket</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">template_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LoadJobConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21600</span><span class="p">,</span>
        <span class="o">**</span><span class="n">load_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy a file from s3 to BigQuery.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            table_name: str</span>
<span class="sd">                The table name and schema (``tmc.cool_table``) to point the file.</span>
<span class="sd">            bucket: str</span>
<span class="sd">                The s3 bucket where the file or manifest is located.</span>
<span class="sd">            key: str</span>
<span class="sd">                The key of the file or manifest in the s3 bucket.</span>
<span class="sd">            if_exists: str</span>
<span class="sd">                If the table already exists, either ``fail``, ``append``, ``drop``</span>
<span class="sd">                or ``truncate`` the table.</span>
<span class="sd">            max_errors: int</span>
<span class="sd">                The maximum number of rows that can error and be skipped before</span>
<span class="sd">                the job fails.</span>
<span class="sd">            data_type: str</span>
<span class="sd">                The data type of the file. Only ``csv`` supported currently.</span>
<span class="sd">            csv_delimiter: str</span>
<span class="sd">                The delimiter of the ``csv``. Only relevant if data_type is ``csv``.</span>
<span class="sd">            ignoreheader: int</span>
<span class="sd">                The number of header rows to skip. Ignored if data_type is ``json``.</span>
<span class="sd">            nullas: str</span>
<span class="sd">                Loads fields that match string as NULL</span>
<span class="sd">            aws_access_key_id:</span>
<span class="sd">                An AWS access key granted to the bucket where the file is located. Not required</span>
<span class="sd">                if keys are stored as environmental variables.</span>
<span class="sd">            aws_secret_access_key:</span>
<span class="sd">                An AWS secret access key granted to the bucket where the file is located. Not</span>
<span class="sd">                required if keys are stored as environmental variables.</span>
<span class="sd">            gcs_client: object</span>
<span class="sd">                The GoogleCloudStorage Connector to use for loading data into Google Cloud Storage.</span>
<span class="sd">            tmp_gcs_bucket: str</span>
<span class="sd">                The name of the Google Cloud Storage bucket to use to stage the data to load</span>
<span class="sd">                into BigQuery. Required if `GCS_TEMP_BUCKET` is not specified or set on</span>
<span class="sd">                the class instance.</span>
<span class="sd">            template_table: str</span>
<span class="sd">                Table name to be used as the load schema. Load operation wil use the same</span>
<span class="sd">                columns and data types as the template table.</span>
<span class="sd">            job_config: object</span>
<span class="sd">                A LoadJobConfig object to provide to the underlying call to load_table_from_uri</span>
<span class="sd">                on the BigQuery client. The function will create its own if not provided. Note</span>
<span class="sd">                if there are any conflicts between the job_config and other parameters, the</span>
<span class="sd">                job_config values are preferred.</span>
<span class="sd">            max_timeout: int</span>
<span class="sd">                The maximum number of seconds to wait for a request before the job fails.</span>

<span class="sd">        `Returns`</span>
<span class="sd">            Parsons Table or ``None``</span>
<span class="sd">                See :ref:`parsons-table` for output options.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># copy from S3 to GCS</span>
        <span class="n">tmp_gcs_bucket</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tmp_gcs_bucket</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_gcs_bucket</span>
            <span class="ow">or</span> <span class="n">check_env</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;GCS_TEMP_BUCKET&quot;</span><span class="p">,</span> <span class="n">tmp_gcs_bucket</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">gcs_client</span> <span class="o">=</span> <span class="n">gcs_client</span> <span class="ow">or</span> <span class="n">GoogleCloudStorage</span><span class="p">()</span>
        <span class="n">temp_blob_uri</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">copy_s3_to_gcs</span><span class="p">(</span>
            <span class="n">aws_source_bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
            <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">aws_access_key_id</span><span class="p">,</span>
            <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">aws_secret_access_key</span><span class="p">,</span>
            <span class="n">gcs_sink_bucket</span><span class="o">=</span><span class="n">tmp_gcs_bucket</span><span class="p">,</span>
            <span class="n">aws_s3_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">temp_blob_name</span> <span class="o">=</span> <span class="n">key</span>
        <span class="n">temp_blob_uri</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">format_uri</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">tmp_gcs_bucket</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">temp_blob_name</span><span class="p">)</span>

        <span class="c1"># load CSV from Cloud Storage into BigQuery</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_from_gcs</span><span class="p">(</span>
                <span class="n">gcs_blob_uri</span><span class="o">=</span><span class="n">temp_blob_uri</span><span class="p">,</span>
                <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">,</span>
                <span class="n">max_errors</span><span class="o">=</span><span class="n">max_errors</span><span class="p">,</span>
                <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
                <span class="n">csv_delimiter</span><span class="o">=</span><span class="n">csv_delimiter</span><span class="p">,</span>
                <span class="n">ignoreheader</span><span class="o">=</span><span class="n">ignoreheader</span><span class="p">,</span>
                <span class="n">nullas</span><span class="o">=</span><span class="n">nullas</span><span class="p">,</span>
                <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
                <span class="n">template_table</span><span class="o">=</span><span class="n">template_table</span><span class="p">,</span>
                <span class="n">max_timeout</span><span class="o">=</span><span class="n">max_timeout</span><span class="p">,</span>
                <span class="o">**</span><span class="n">load_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">gcs_client</span><span class="o">.</span><span class="n">delete_blob</span><span class="p">(</span><span class="n">tmp_gcs_bucket</span><span class="p">,</span> <span class="n">temp_blob_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="GoogleBigQuery.copy">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.copy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tbl</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">if_exists</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fail&quot;</span><span class="p">,</span>
        <span class="n">max_errors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">tmp_gcs_bucket</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gcs_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GoogleCloudStorage</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LoadJobConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">template_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignoreheader</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">nullas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_quoted_newlines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_jagged_rows</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">quote</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21600</span><span class="p">,</span>
        <span class="n">convert_dict_columns_to_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">load_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy a :ref:`parsons-table` into Google BigQuery via Google Cloud Storage.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            tbl: obj</span>
<span class="sd">                The Parsons Table to copy into BigQuery.</span>
<span class="sd">            table_name: str</span>
<span class="sd">                The table name to load the data into. Will be used to generate load schema</span>
<span class="sd">                if no custom schema or template table are supplied and if_exists is</span>
<span class="sd">                set to &quot;truncate&quot; or &quot;append&quot;.</span>
<span class="sd">            if_exists: str</span>
<span class="sd">                If the table already exists, either ``fail``, ``append``, ``drop``</span>
<span class="sd">                or ``truncate`` the table.</span>
<span class="sd">            max_errors: int</span>
<span class="sd">                The maximum number of rows that can error and be skipped before</span>
<span class="sd">                the job fails.</span>
<span class="sd">            tmp_gcs_bucket: str</span>
<span class="sd">                The name of the Google Cloud Storage bucket to use to stage the data to load</span>
<span class="sd">                into BigQuery. Required if `GCS_TEMP_BUCKET` is not specified or set on</span>
<span class="sd">                the class instance.</span>
<span class="sd">            gcs_client: object</span>
<span class="sd">                The GoogleCloudStorage Connector to use for loading data into Google Cloud Storage.</span>
<span class="sd">            job_config: object</span>
<span class="sd">                A LoadJobConfig object to provide to the underlying call to load_table_from_uri</span>
<span class="sd">                on the BigQuery client. The function will create its own if not provided.</span>
<span class="sd">            template_table: str</span>
<span class="sd">                Table name to be used as the load schema. Load operation wil use the same</span>
<span class="sd">                columns and data types as the template table.</span>
<span class="sd">            max_timeout: int</span>
<span class="sd">                The maximum number of seconds to wait for a request before the job fails.</span>
<span class="sd">            convert_dict_columns_to_json: bool</span>
<span class="sd">                If set to True, will convert any dict columns (which cannot by default be successfully loaded to BigQuery to JSON strings)</span>
<span class="sd">            **load_kwargs: kwargs</span>
<span class="sd">                Arguments to pass to the underlying load_table_from_uri call on the BigQuery</span>
<span class="sd">                client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>
        <span class="n">tmp_gcs_bucket</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tmp_gcs_bucket</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_gcs_bucket</span>
            <span class="ow">or</span> <span class="n">check_env</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;GCS_TEMP_BUCKET&quot;</span><span class="p">,</span> <span class="n">tmp_gcs_bucket</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tmp_gcs_bucket</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Must set GCS_TEMP_BUCKET environment variable or pass in tmp_gcs_bucket parameter&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_copy_inputs</span><span class="p">(</span><span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">)</span>

        <span class="c1"># If our source table is loaded from CSV with no transformations</span>
        <span class="c1"># The original source file will be directly loaded to GCS</span>
        <span class="c1"># We may need to pass along a custom delimiter to BigQuery</span>
        <span class="c1"># Otherwise we use the default comma</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">petl</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">csv_py3</span><span class="o">.</span><span class="n">CSVView</span><span class="p">):</span>
            <span class="n">csv_delimiter</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">csvargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delimiter&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">csv_delimiter</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span>

        <span class="k">if</span> <span class="n">convert_dict_columns_to_json</span><span class="p">:</span>
            <span class="c1"># Convert dict columns to JSON strings</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">tbl</span><span class="o">.</span><span class="n">get_columns_type_stats</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;dict&quot;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
                    <span class="n">new_petl</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">addfield</span><span class="p">(</span>
                        <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_replace&quot;</span><span class="p">,</span>
                        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]),</span>
                    <span class="p">)</span>
                    <span class="n">new_tbl</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">new_petl</span><span class="p">)</span>
                    <span class="n">new_tbl</span><span class="o">.</span><span class="n">remove_column</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                    <span class="n">new_tbl</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_replace&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                    <span class="n">new_tbl</span><span class="o">.</span><span class="n">materialize</span><span class="p">()</span>
                    <span class="n">tbl</span> <span class="o">=</span> <span class="n">new_tbl</span>

        <span class="n">job_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_job_config</span><span class="p">(</span>
            <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
            <span class="n">destination_table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
            <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">,</span>
            <span class="n">max_errors</span><span class="o">=</span><span class="n">max_errors</span><span class="p">,</span>
            <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
            <span class="n">template_table</span><span class="o">=</span><span class="n">template_table</span><span class="p">,</span>
            <span class="n">parsons_table</span><span class="o">=</span><span class="n">tbl</span><span class="p">,</span>
            <span class="n">ignoreheader</span><span class="o">=</span><span class="n">ignoreheader</span><span class="p">,</span>
            <span class="n">nullas</span><span class="o">=</span><span class="n">nullas</span><span class="p">,</span>
            <span class="n">allow_quoted_newlines</span><span class="o">=</span><span class="n">allow_quoted_newlines</span><span class="p">,</span>
            <span class="n">allow_jagged_rows</span><span class="o">=</span><span class="n">allow_jagged_rows</span><span class="p">,</span>
            <span class="n">quote</span><span class="o">=</span><span class="n">quote</span><span class="p">,</span>
            <span class="n">custom_schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">csv_delimiter</span><span class="o">=</span><span class="n">csv_delimiter</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Reorder schema to match table to ensure compatibility</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">tbl</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">schema_row</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">job_config</span><span class="o">.</span><span class="n">schema</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">column</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column found in Table that was not found in schema: </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">schema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">schema_row</span><span class="p">)</span>
        <span class="n">job_config</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span>

        <span class="n">gcs_client</span> <span class="o">=</span> <span class="n">gcs_client</span> <span class="ow">or</span> <span class="n">GoogleCloudStorage</span><span class="p">(</span><span class="n">app_creds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app_creds</span><span class="p">)</span>
        <span class="n">temp_blob_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">temp_blob_uri</span> <span class="o">=</span> <span class="n">gcs_client</span><span class="o">.</span><span class="n">upload_table</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">tmp_gcs_bucket</span><span class="p">,</span> <span class="n">temp_blob_name</span><span class="p">)</span>

        <span class="c1"># load CSV from Cloud Storage into BigQuery</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_table_from_uri</span><span class="p">(</span>
                <span class="n">source_uris</span><span class="o">=</span><span class="n">temp_blob_uri</span><span class="p">,</span>
                <span class="n">destination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_table_ref</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">),</span>
                <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
                <span class="n">max_timeout</span><span class="o">=</span><span class="n">max_timeout</span><span class="p">,</span>
                <span class="o">**</span><span class="n">load_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">gcs_client</span><span class="o">.</span><span class="n">delete_blob</span><span class="p">(</span><span class="n">tmp_gcs_bucket</span><span class="p">,</span> <span class="n">temp_blob_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="GoogleBigQuery.duplicate_table">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.duplicate_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">duplicate_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source_table</span><span class="p">,</span>
        <span class="n">destination_table</span><span class="p">,</span>
        <span class="n">if_exists</span><span class="o">=</span><span class="s2">&quot;fail&quot;</span><span class="p">,</span>
        <span class="n">drop_source_table</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a copy of an existing table (or subset of rows) in a new</span>
<span class="sd">        table.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            source_table: str</span>
<span class="sd">                Name of existing schema and table (e.g. ``myschema.oldtable``)</span>
<span class="sd">            destination_table: str</span>
<span class="sd">                Name of destination schema and table (e.g. ``myschema.newtable``)</span>
<span class="sd">            if_exists: str</span>
<span class="sd">                If the table already exists, either ``fail``, ``replace``, or</span>
<span class="sd">                ``ignore`` the operation.</span>
<span class="sd">            drop_source_table: boolean</span>
<span class="sd">                Drop the source table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">if_exists</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fail&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for `if_exists` argument&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s2">&quot;fail&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">destination_table</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Table already exists.&quot;</span><span class="p">)</span>

        <span class="n">table__replace_clause</span> <span class="o">=</span> <span class="s2">&quot;OR REPLACE &quot;</span> <span class="k">if</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s2">&quot;replace&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">table__exists_clause</span> <span class="o">=</span> <span class="s2">&quot; IF NOT EXISTS&quot;</span> <span class="k">if</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s2">&quot;ignore&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE </span><span class="si">{</span><span class="n">table__replace_clause</span><span class="si">}</span><span class="s2">TABLE</span><span class="si">{</span><span class="n">table__exists_clause</span><span class="si">}</span>
<span class="s2">            </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span>
<span class="s2">            CLONE </span><span class="si">{</span><span class="n">source_table</span><span class="si">}</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">return_values</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">drop_source_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_table</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">source_table</span><span class="p">)</span></div>


<div class="viewcode-block" id="GoogleBigQuery.upsert">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.upsert">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">upsert</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table_obj</span><span class="p">,</span>
        <span class="n">target_table</span><span class="p">,</span>
        <span class="n">primary_key</span><span class="p">,</span>
        <span class="n">distinct_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cleanup_temp_table</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">from_s3</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">copy_args</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preform an upsert on an existing table. An upsert is a function in which rows</span>
<span class="sd">        in a table are updated and inserted at the same time.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            table_obj: obj</span>
<span class="sd">                A Parsons table object</span>
<span class="sd">            target_table: str</span>
<span class="sd">                The schema and table name to upsert</span>
<span class="sd">            primary_key: str or list</span>
<span class="sd">                The primary key column(s) of the target table</span>
<span class="sd">            distinct_check: boolean</span>
<span class="sd">                Check if the primary key column is distinct. Raise error if not.</span>
<span class="sd">            cleanup_temp_table: boolean</span>
<span class="sd">                A temp table is dropped by default on cleanup. You can set to False for debugging.</span>
<span class="sd">            from_s3: boolean</span>
<span class="sd">                Instead of specifying a table_obj (set the first argument to None),</span>
<span class="sd">                set this to True and include :func:`~parsons.databases.bigquery.Bigquery.copy_s3`</span>
<span class="sd">                arguments to upsert a pre-existing s3 file into the target_table</span>
<span class="sd">            \**copy_args: kwargs</span>
<span class="sd">                See :func:`~parsons.databases.bigquery.BigQuery.copy` for options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">target_table</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Target table does not exist. Copying into newly </span><span class="se">\</span>
<span class="s2">                         created target table.&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">table_obj</span><span class="p">,</span> <span class="n">target_table</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">primary_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">primary_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">primary_key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">primary_keys</span> <span class="o">=</span> <span class="n">primary_key</span>

        <span class="k">if</span> <span class="n">distinct_check</span><span class="p">:</span>
            <span class="n">primary_keys_statement</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">primary_keys</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                select (</span>
<span class="s2">                    select count(*)</span>
<span class="s2">                    from </span><span class="si">{</span><span class="n">target_table</span><span class="si">}</span>
<span class="s2">                ) - (</span>
<span class="s2">                    SELECT COUNT(*) from (</span>
<span class="s2">                        select distinct </span><span class="si">{</span><span class="n">primary_keys_statement</span><span class="si">}</span>
<span class="s2">                        from </span><span class="si">{</span><span class="n">target_table</span><span class="si">}</span>
<span class="s2">                    )</span>
<span class="s2">                ) as total_count</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">first</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Primary key column contains duplicate values.&quot;</span><span class="p">)</span>

        <span class="n">noise</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">)</span><span class="si">:</span><span class="s2">04</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">date_stamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M&quot;</span><span class="p">)</span>
        <span class="c1"># Generate a temp table like &quot;table_tmp_20200210_1230_14212&quot;</span>
        <span class="n">staging_tbl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_table</span><span class="si">}</span><span class="s2">_stg_</span><span class="si">{</span><span class="n">date_stamp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">noise</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Copy to a staging table</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building staging table: </span><span class="si">{</span><span class="n">staging_tbl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">from_s3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">table_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;upsert(... from_s3=True) requires the first argument (table_obj)&quot;</span>
                    <span class="s2">&quot; to be None. from_s3 and table_obj are mutually exclusive.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy_s3</span><span class="p">(</span><span class="n">staging_tbl</span><span class="p">,</span> <span class="n">template_table</span><span class="o">=</span><span class="n">target_table</span><span class="p">,</span> <span class="o">**</span><span class="n">copy_args</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                <span class="n">tbl</span><span class="o">=</span><span class="n">table_obj</span><span class="p">,</span>
                <span class="n">table_name</span><span class="o">=</span><span class="n">staging_tbl</span><span class="p">,</span>
                <span class="n">template_table</span><span class="o">=</span><span class="n">target_table</span><span class="p">,</span>
                <span class="o">**</span><span class="n">copy_args</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Delete rows</span>
        <span class="n">comparisons</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">staging_tbl</span><span class="si">}</span><span class="s2">`.</span><span class="si">{</span><span class="n">primary_key</span><span class="si">}</span><span class="s2"> = `</span><span class="si">{</span><span class="n">target_table</span><span class="si">}</span><span class="s2">`.</span><span class="si">{</span><span class="n">primary_key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">primary_key</span> <span class="ow">in</span> <span class="n">primary_keys</span>
        <span class="p">]</span>
        <span class="n">where_clause</span> <span class="o">=</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comparisons</span><span class="p">)</span>

        <span class="n">queries</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                DELETE FROM `</span><span class="si">{</span><span class="n">target_table</span><span class="si">}</span><span class="s2">`</span>
<span class="s2">                WHERE EXISTS</span>
<span class="s2">                (SELECT * FROM `</span><span class="si">{</span><span class="n">staging_tbl</span><span class="si">}</span><span class="s2">`</span>
<span class="s2">                WHERE </span><span class="si">{</span><span class="n">where_clause</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO `</span><span class="si">{</span><span class="n">target_table</span><span class="si">}</span><span class="s2">`</span>
<span class="s2">                SELECT * FROM `</span><span class="si">{</span><span class="n">staging_tbl</span><span class="si">}</span><span class="s2">`</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_with_transaction</span><span class="p">(</span><span class="n">queries</span><span class="o">=</span><span class="n">queries</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cleanup_temp_table</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting staging table: </span><span class="si">{</span><span class="n">staging_tbl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DROP TABLE IF EXISTS </span><span class="si">{</span><span class="n">staging_tbl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">return_values</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="GoogleBigQuery.delete_table">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.delete_table">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a BigQuery table.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            table_name: str</span>
<span class="sd">                The name of the table to delete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_ref</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">delete_table</span><span class="p">(</span><span class="n">table_ref</span><span class="p">)</span></div>


<div class="viewcode-block" id="GoogleBigQuery.table_exists">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.table_exists">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">table_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether or not the Google BigQuery table exists in the specified dataset.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            table_name: str</span>
<span class="sd">                The name of the BigQuery table to check for</span>
<span class="sd">        `Returns:`</span>
<span class="sd">            bool</span>
<span class="sd">                True if the table exists in the specified dataset, false otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_ref</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">table_ref</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="GoogleBigQuery.get_tables">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.get_tables">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List the tables in a schema including metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            schema: str</span>
<span class="sd">                Filter by a schema</span>
<span class="sd">            table_name: str</span>
<span class="sd">                Filter by a table name</span>
<span class="sd">        `Returns:`</span>
<span class="sd">            Parsons Table</span>
<span class="sd">                See :ref:`parsons-table` for output options.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving tables info.&quot;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;select * from </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">.INFORMATION_SCHEMA.TABLES&quot;</span>
        <span class="k">if</span> <span class="n">table_name</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; where table_name = &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>


<div class="viewcode-block" id="GoogleBigQuery.get_views">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.get_views">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">view</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List views.</span>

<span class="sd">        Args:</span>
<span class="sd">            schema: str</span>
<span class="sd">                Filter by a schema</span>
<span class="sd">            view: str</span>
<span class="sd">                Filter by a table name</span>
<span class="sd">        `Returns:`</span>
<span class="sd">            Parsons Table</span>
<span class="sd">                See :ref:`parsons-table` for output options.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retrieving views info.&quot;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">              select</span>
<span class="s2">                table_schema as schema_name,</span>
<span class="s2">                table_name as view_name,</span>
<span class="s2">                view_definition</span>
<span class="s2">              from </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">.INFORMATION_SCHEMA.VIEWS</span>
<span class="s2">              &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">view</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; where table_name = &#39;</span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>


<div class="viewcode-block" id="GoogleBigQuery.get_columns">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.get_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the column names (and other column metadata) for a table. If you</span>
<span class="sd">        need just the column names run ``get_columns_list()``, as it is faster.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            schema: str</span>
<span class="sd">                The schema name</span>
<span class="sd">            table_name: str</span>
<span class="sd">                The table name</span>

<span class="sd">        `Returns:`</span>
<span class="sd">            A dictionary mapping column name to a dictionary with extra info. The</span>
<span class="sd">            keys of the dictionary are ordered just liked the columns in the table.</span>
<span class="sd">            The extra info is a dict with format</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">base_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT</span>
<span class="s2">            *</span>
<span class="s2">        FROM `</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">.INFORMATION_SCHEMA.COLUMNS`</span>
<span class="s2">        WHERE</span>
<span class="s2">            table_name = &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">base_query</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;column_name&quot;</span><span class="p">]:</span> <span class="p">{</span>
                <span class="s2">&quot;data_type&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;data_type&quot;</span><span class="p">],</span>
                <span class="s2">&quot;is_nullable&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;is_nullable&quot;</span><span class="p">],</span>
                <span class="s2">&quot;is_updatable&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;is_updatable&quot;</span><span class="p">],</span>
                <span class="s2">&quot;is_partioning_column&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;is_partitioning_column&quot;</span><span class="p">],</span>
                <span class="s2">&quot;rounding_mode&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;rounding_mode&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">base_query</span><span class="p">)</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="GoogleBigQuery.get_columns_list">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.get_columns_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_columns_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the column names for a table.</span>

<span class="sd">        `Args:`</span>
<span class="sd">            schema: str</span>
<span class="sd">                The schema name</span>
<span class="sd">            table_name: str</span>
<span class="sd">                The table name</span>

<span class="sd">        `Returns:`</span>
<span class="sd">            A list of column names</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">first_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> LIMIT 1;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">first_row</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span></div>


<div class="viewcode-block" id="GoogleBigQuery.get_row_count">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.get_row_count">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_row_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the row count for a BigQuery materialization.</span>

<span class="sd">        Caution: This method uses SELECT COUNT(*) which can be expensive for large tables,</span>
<span class="sd">        especially those with many columns. This is because BigQuery scans all table data</span>
<span class="sd">        to perform the count, even though only the row count is returned.</span>

<span class="sd">        `Args`:</span>
<span class="sd">            schema: str</span>
<span class="sd">                The schema name</span>
<span class="sd">            table_name: str</span>
<span class="sd">                The table name</span>

<span class="sd">        `Returns:`</span>
<span class="sd">            Row count of the target table</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT COUNT(*) AS row_count FROM `</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">`&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;row_count&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_table_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="c1"># Helper function to build a TableReference for our table</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_table_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="n">dataset_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">dataset_ref</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">parsed</span><span class="p">[</span><span class="s2">&quot;table&quot;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_job_config_schema</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">job_config</span><span class="p">:</span> <span class="n">LoadJobConfig</span><span class="p">,</span>
        <span class="n">destination_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">if_exists</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">parsons_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Table</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">template_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">bigquery</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">]]:</span>
        <span class="c1"># if job.schema already set in job_config, do nothing</span>
        <span class="k">if</span> <span class="n">job_config</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">job_config</span><span class="o">.</span><span class="n">schema</span>
        <span class="c1"># if schema specified by user, convert to schema type and use that</span>
        <span class="k">if</span> <span class="n">custom_schema</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">map_column_headers_to_schema_field</span><span class="p">(</span><span class="n">custom_schema</span><span class="p">)</span>
        <span class="c1"># if template_table specified by user, use that</span>
        <span class="c1"># otherwise, if loading into existing table, infer destination table as template table</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">template_table</span> <span class="ow">and</span> <span class="n">if_exists</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">,</span> <span class="s2">&quot;truncate&quot;</span><span class="p">):</span>
            <span class="n">template_table</span> <span class="o">=</span> <span class="n">destination_table_name</span>
        <span class="c1"># if template_table set, use it to set the load schema</span>
        <span class="k">if</span> <span class="n">template_table</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bigquery_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">template_table</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">bigquery_table</span><span class="o">.</span><span class="n">schema</span>
            <span class="k">except</span> <span class="n">google</span><span class="o">.</span><span class="n">api_core</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;template_table &#39;</span><span class="si">{</span><span class="n">template_table</span><span class="si">}</span><span class="s2">&#39; not found. Unable to set schema.&quot;</span>
                <span class="p">)</span>
        <span class="c1"># if load is coming from a Parsons table, use that to generate schema</span>
        <span class="k">if</span> <span class="n">parsons_table</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_schema_from_parsons_table</span><span class="p">(</span><span class="n">parsons_table</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_schema_from_parsons_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;BigQuery schema generation based on contents of Parsons table.</span>

<span class="sd">        Not usually necessary to use this. BigQuery is able to</span>
<span class="sd">        natively autodetect schema formats.&quot;&quot;&quot;</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">get_columns_type_stats</span><span class="p">()</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">petl_types</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

            <span class="c1"># Prefer &#39;str&#39; if included</span>
            <span class="c1"># Otherwise choose first type that isn&#39;t &quot;NoneType&quot;</span>
            <span class="c1"># Otherwise choose NoneType</span>
            <span class="n">not_none_petl_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">petl_types</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s2">&quot;NoneType&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;str&quot;</span> <span class="ow">in</span> <span class="n">petl_types</span><span class="p">:</span>
                <span class="n">best_type</span> <span class="o">=</span> <span class="s2">&quot;str&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;int&quot;</span> <span class="ow">in</span> <span class="n">petl_types</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;float&quot;</span> <span class="ow">in</span> <span class="n">petl_types</span><span class="p">):</span>
                <span class="n">best_type</span> <span class="o">=</span> <span class="s2">&quot;float&quot;</span>
            <span class="k">elif</span> <span class="n">not_none_petl_types</span><span class="p">:</span>
                <span class="n">best_type</span> <span class="o">=</span> <span class="n">not_none_petl_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">best_type</span> <span class="o">=</span> <span class="s2">&quot;NoneType&quot;</span>

            <span class="c1"># Python datetimes may be datetime or timestamp in BigQuery</span>
            <span class="c1"># BigQuery datetimes have no timezone, timestamps do</span>
            <span class="k">if</span> <span class="n">best_type</span> <span class="o">==</span> <span class="s2">&quot;datetime&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">petl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">stat</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">:</span>
                        <span class="n">best_type</span> <span class="o">=</span> <span class="s2">&quot;timestamp&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">field_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bigquery_type</span><span class="p">(</span><span class="n">best_type</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="s2">&quot;Column type not supported for load to BigQuery. &quot;</span>
                    <span class="s2">&quot;Consider converting to another type. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;[type=</span><span class="si">{</span><span class="n">best_type</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">SchemaField</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">field_type</span><span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fields</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_job_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">destination_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">if_exists</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">max_errors</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">csv_delimiter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span>
        <span class="n">ignoreheader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">nullas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_quoted_newlines</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_jagged_rows</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">quote</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LoadJobConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">template_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parsons_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Table</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LoadJobConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal function to neatly process a user-supplied job configuration object.</span>
<span class="sd">        As a convention, if both the job_config and keyword arguments specify a value,</span>
<span class="sd">        we defer to the job_config.</span>

<span class="sd">        `Args`:</span>
<span class="sd">            job_config: `LoadJobConfig`</span>
<span class="sd">                Optionally supplied GCS `LoadJobConfig` object</span>

<span class="sd">        `Returns`:</span>
<span class="sd">            A `LoadJobConfig` object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="p">:</span>
            <span class="n">job_config</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">LoadJobConfig</span><span class="p">()</span>

        <span class="n">job_config</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_job_config_schema</span><span class="p">(</span>
            <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
            <span class="n">destination_table_name</span><span class="o">=</span><span class="n">destination_table_name</span><span class="p">,</span>
            <span class="n">if_exists</span><span class="o">=</span><span class="n">if_exists</span><span class="p">,</span>
            <span class="n">parsons_table</span><span class="o">=</span><span class="n">parsons_table</span><span class="p">,</span>
            <span class="n">custom_schema</span><span class="o">=</span><span class="n">custom_schema</span><span class="p">,</span>
            <span class="n">template_table</span><span class="o">=</span><span class="n">template_table</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">autodetect</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">create_disposition</span><span class="p">:</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">create_disposition</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">CreateDisposition</span><span class="o">.</span><span class="n">CREATE_IF_NEEDED</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">max_bad_records</span><span class="p">:</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">max_bad_records</span> <span class="o">=</span> <span class="n">max_errors</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">skip_leading_rows</span> <span class="ow">and</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">skip_leading_rows</span> <span class="o">=</span> <span class="n">ignoreheader</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">source_format</span><span class="p">:</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">source_format</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bigquery</span><span class="o">.</span><span class="n">SourceFormat</span><span class="o">.</span><span class="n">CSV</span>
                <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span>
                <span class="k">else</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">SourceFormat</span><span class="o">.</span><span class="n">NEWLINE_DELIMITED_JSON</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">field_delimiter</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="n">job_config</span><span class="o">.</span><span class="n">field_delimiter</span> <span class="o">=</span> <span class="n">csv_delimiter</span>
            <span class="k">if</span> <span class="n">nullas</span><span class="p">:</span>
                <span class="n">job_config</span><span class="o">.</span><span class="n">null_marker</span> <span class="o">=</span> <span class="n">nullas</span>

        <span class="n">destination_table_exists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">destination_table_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">write_disposition</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s2">&quot;append&quot;</span><span class="p">:</span>
                <span class="n">job_config</span><span class="o">.</span><span class="n">write_disposition</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">WriteDisposition</span><span class="o">.</span><span class="n">WRITE_APPEND</span>
            <span class="k">elif</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s2">&quot;truncate&quot;</span><span class="p">:</span>
                <span class="n">job_config</span><span class="o">.</span><span class="n">write_disposition</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">WriteDisposition</span><span class="o">.</span><span class="n">WRITE_TRUNCATE</span>
            <span class="k">elif</span> <span class="n">destination_table_exists</span> <span class="ow">and</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s2">&quot;fail&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Table already exists.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">if_exists</span> <span class="o">==</span> <span class="s2">&quot;drop&quot;</span> <span class="ow">and</span> <span class="n">destination_table_exists</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_table</span><span class="p">(</span><span class="n">destination_table_name</span><span class="p">)</span>
                <span class="n">job_config</span><span class="o">.</span><span class="n">write_disposition</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">WriteDisposition</span><span class="o">.</span><span class="n">WRITE_EMPTY</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">job_config</span><span class="o">.</span><span class="n">write_disposition</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">WriteDisposition</span><span class="o">.</span><span class="n">WRITE_EMPTY</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">allow_quoted_newlines</span> <span class="ow">and</span> <span class="n">allow_quoted_newlines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">allow_quoted_newlines</span> <span class="o">=</span> <span class="n">allow_quoted_newlines</span>

        <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span> <span class="ow">and</span> <span class="n">allow_jagged_rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">allow_jagged_rows</span> <span class="o">=</span> <span class="n">allow_jagged_rows</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="o">.</span><span class="n">quote_character</span> <span class="ow">and</span> <span class="n">quote</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_config</span><span class="o">.</span><span class="n">quote_character</span> <span class="o">=</span> <span class="n">quote</span>

        <span class="k">return</span> <span class="n">job_config</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_query_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
        <span class="c1"># We will use a temp file to cache the results so that they are not all living</span>
        <span class="c1"># in memory. We&#39;ll use pickle to serialize the results to file in order to maintain</span>
        <span class="c1"># the proper data types (e.g. integer).</span>
        <span class="n">temp_filename</span> <span class="o">=</span> <span class="n">create_temp_file</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">temp_file</span><span class="p">)</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="n">QUERY_BATCH_SIZE</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
                    <span class="n">row_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">row_data</span><span class="p">,</span> <span class="n">temp_file</span><span class="p">)</span>

        <span class="n">ptable</span> <span class="o">=</span> <span class="n">petl</span><span class="o">.</span><span class="n">frompickle</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Table</span><span class="p">(</span><span class="n">ptable</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_copy_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">if_exists</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">if_exists</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fail&quot;</span><span class="p">,</span> <span class="s2">&quot;truncate&quot;</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span> <span class="s2">&quot;drop&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected value for if_exists: </span><span class="si">{</span><span class="n">if_exists</span><span class="si">}</span><span class="s2">, must be one of &quot;</span>
                <span class="s1">&#39;&quot;append&quot;, &quot;drop&quot;, &quot;truncate&quot;, or &quot;fail&quot;&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only supports csv or json files [data_type = </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_table_from_uri</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">source_uris</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">job_config</span><span class="p">,</span> <span class="n">max_timeout</span><span class="p">,</span> <span class="o">**</span><span class="n">load_kwargs</span>
    <span class="p">):</span>
        <span class="n">load_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">load_table_from_uri</span><span class="p">(</span>
            <span class="n">source_uris</span><span class="o">=</span><span class="n">source_uris</span><span class="p">,</span>
            <span class="n">destination</span><span class="o">=</span><span class="n">destination</span><span class="p">,</span>
            <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
            <span class="o">**</span><span class="n">load_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">load_job</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">max_timeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">load_job</span>
        <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">BadRequest</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">error_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">load_job</span><span class="o">.</span><span class="n">errors</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;* Load job failed. Enumerating errors collection below:&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;** Error collection - index </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">e</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_bigquery_type</span><span class="p">(</span><span class="n">tp</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BIGQUERY_TYPE_MAP</span><span class="p">[</span><span class="n">tp</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
        <span class="c1"># Return a MySQL table object</span>

        <span class="k">return</span> <span class="n">BigQueryTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>

<div class="viewcode-block" id="GoogleBigQuery.extract">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.extract">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">gcs_bucket</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">gcs_blob_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gzip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;US&quot;</span><span class="p">,</span>
        <span class="n">destination_file_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CSV&quot;</span><span class="p">,</span>
        <span class="n">field_delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span>
        <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">job_config</span><span class="p">:</span> <span class="n">ExtractJobConfig</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wait_for_job_to_complete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">export_kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts a BigQuery table to a Google Cloud Storage bucket.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (str): The BigQuery dataset containing the table.</span>
<span class="sd">            table_name (str): The name of the table to extract.</span>
<span class="sd">            gcs_bucket (str): The GCS bucket where the table will be</span>
<span class="sd">              exported.</span>
<span class="sd">            gcs_blob_name (str): The name of the blob in the GCS</span>
<span class="sd">              bucket.</span>
<span class="sd">            project (Optional[str]): The Google Cloud project ID. If</span>
<span class="sd">              not provided, the default project of the client is used.</span>
<span class="sd">            gzip (bool): If True, the exported file will be compressed</span>
<span class="sd">              using GZIP. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_config</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using default job config as none was provided...&quot;</span><span class="p">)</span>
            <span class="n">job_config</span> <span class="o">=</span> <span class="n">ExtractJobConfig</span><span class="p">(</span>
                <span class="n">destination_format</span><span class="o">=</span><span class="n">destination_file_format</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                <span class="n">field_delimiter</span><span class="o">=</span><span class="n">field_delimiter</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">gs_destination</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;gs://</span><span class="si">{</span><span class="n">gcs_bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">gcs_blob_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">compression</span> <span class="o">=</span> <span class="s2">&quot;GZIP&quot;</span> <span class="k">if</span> <span class="n">gzip</span> <span class="k">else</span> <span class="n">compression</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project (parsons): </span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">extract_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">extract_table</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">destination_uris</span><span class="o">=</span><span class="n">gs_destination</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
            <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
            <span class="o">**</span><span class="n">export_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">wait_for_job_to_complete</span><span class="p">:</span>
            <span class="n">extract_job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished exporting query result to </span><span class="si">{</span><span class="n">gs_destination</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">extract_job</span></div>


<div class="viewcode-block" id="GoogleBigQuery.copy_between_projects">
<a class="viewcode-back" href="../../../google.html#parsons.google.google_bigquery.GoogleBigQuery.copy_between_projects">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy_between_projects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source_project</span><span class="p">,</span>
        <span class="n">source_dataset</span><span class="p">,</span>
        <span class="n">source_table</span><span class="p">,</span>
        <span class="n">destination_project</span><span class="p">,</span>
        <span class="n">destination_dataset</span><span class="p">,</span>
        <span class="n">destination_table</span><span class="p">,</span>
        <span class="n">if_dataset_not_exists</span><span class="o">=</span><span class="s2">&quot;fail&quot;</span><span class="p">,</span>
        <span class="n">if_table_exists</span><span class="o">=</span><span class="s2">&quot;fail&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy a table from one project to another. Fails if the source or target project</span>
<span class="sd">            does not exist.</span>
<span class="sd">        If the target dataset does not exist, fhe flag if_dataset_not_exists controls behavior.</span>
<span class="sd">            It defaults to &#39;fail&#39;; set it to &#39;create&#39; if it&#39;s ok to create it.</span>
<span class="sd">        If the target table exists, the flag if_table_exists controls behavior.</span>
<span class="sd">            It defaults to &#39;fail&#39;; set it to &#39;overwrite&#39; if it&#39;s ok to overwrite an existing table.</span>

<span class="sd">        `Args`:</span>
<span class="sd">            source_project: str</span>
<span class="sd">                Name of source project</span>
<span class="sd">            source_dataset: str</span>
<span class="sd">                Name of source dataset</span>
<span class="sd">            source_table: str</span>
<span class="sd">                Name of source table</span>
<span class="sd">            destination_project: str</span>
<span class="sd">                Name of destination project</span>
<span class="sd">            destination_dataset: str</span>
<span class="sd">                Name of destination dataset</span>
<span class="sd">            destination_table: str</span>
<span class="sd">                Name of destination table</span>
<span class="sd">            if_dataset_not_exists: str</span>
<span class="sd">                Action if dataset doesn&#39;t exist {&#39;fail&#39;,&#39;create&#39;}</span>
<span class="sd">            if_table_exists: str</span>
<span class="sd">                Action if table exists {&#39;fail&#39;, &#39;overwrite&#39;}</span>

<span class="sd">        `Returns:`</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">google.cloud</span><span class="w"> </span><span class="kn">import</span> <span class="n">bigquery</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">google.cloud.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">NotFound</span>

        <span class="n">destination_table_id</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">destination_project</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">destination_dataset</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">destination_table</span>
        <span class="p">)</span>
        <span class="n">source_table_id</span> <span class="o">=</span> <span class="n">source_project</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">source_dataset</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">source_table</span>
        <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">destination_project</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">destination_dataset</span>

        <span class="c1"># check if destination dataset exists</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>  <span class="c1"># Make an API request.</span>
            <span class="c1"># if it exists: continue; if not, check to see if it&#39;s ok to create it</span>
        <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
            <span class="c1"># if it doesn&#39;t exist: check if it&#39;s ok to create it</span>
            <span class="k">if</span> <span class="n">if_dataset_not_exists</span> <span class="o">==</span> <span class="s2">&quot;create&quot;</span><span class="p">:</span>  <span class="c1"># create a new dataset in the destination</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># if it doesn&#39;t exist and it&#39;s not ok to create it, fail</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;BigQuery copy failed&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="n">destination_dataset</span><span class="si">}</span><span class="s2"> does not exist and if_dataset_not_exists set to </span><span class="si">{</span><span class="n">if_dataset_not_exists</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">job_config</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">CopyJobConfig</span><span class="p">()</span>

        <span class="c1"># check if destination table exists</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">destination_table_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">if_table_exists</span> <span class="o">==</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">:</span>  <span class="c1"># if it exists</span>
                <span class="n">job_config</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">CopyJobConfig</span><span class="p">()</span>
                <span class="n">job_config</span><span class="o">.</span><span class="n">write_disposition</span> <span class="o">=</span> <span class="s2">&quot;WRITE_TRUNCATE&quot;</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">copy_table</span><span class="p">(</span>
                    <span class="n">source_table_id</span><span class="p">,</span>
                    <span class="n">destination_table_id</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">,</span>
                    <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;BigQuery copy failed, Table </span><span class="si">{</span><span class="n">destination_table</span><span class="si">}</span><span class="s2"> exists and if_table_exists set to </span><span class="si">{</span><span class="n">if_table_exists</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
            <span class="c1"># destination table doesn&#39;t exist, so we can create one</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">copy_table</span><span class="p">(</span>
                <span class="n">source_table_id</span><span class="p">,</span>
                <span class="n">destination_table_id</span><span class="p">,</span>
                <span class="n">location</span><span class="o">=</span><span class="s2">&quot;US&quot;</span><span class="p">,</span>
                <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>
</div>



<span class="k">class</span><span class="w"> </span><span class="nc">BigQueryTable</span><span class="p">(</span><span class="n">BaseTable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;BigQuery table object.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drop the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">delete_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Truncate the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRUNCATE TABLE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, The Movement Cooperative.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="Versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Most Common</dt>
        <!-- Show latest & stable first -->
        
            
        
            
        
            
        
            
        
            
        
            
        
            
                  <dd><a href="google_bigquery.html">latest</a></dd>
            
        
            
                  <dd><a href="../../../../stable/index.html">stable</a></dd>
            
        

        <dt>By Version Number</dt>
        <!-- Show other versions -->
        
            
                  <dd><a href="../../../../v0.14.0/index.html">v0.14.0</a></dd>
            
        
            
                  <dd><a href="../../../../v0.15.0/index.html">v0.15.0</a></dd>
            
        
            
                  <dd><a href="../../../../v0.16.0/index.html">v0.16.0</a></dd>
            
        
            
                  <dd><a href="../../../../v0.17.0/index.html">v0.17.0</a></dd>
            
        
            
                  <dd><a href="../../../../v0.18.0/index.html">v0.18.0</a></dd>
            
        
            
                  <dd><a href="../../../../v0.18.1/index.html">v0.18.1</a></dd>
            
        
            
        
            
        

      </dl>
    </div>
  </div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>